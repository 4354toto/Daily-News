name: Daily News Auto Publisher - FIXED

on:
  schedule:
    # æ¯å¤© UTC 1:00 è§¦å‘ (åŒ—äº¬æ—¶é—´ 9:00)
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  publish-news:
    runs-on: ubuntu-latest
    steps:
    - name: Log Execution Time
      run: |
        echo "ğŸ•’ å·¥ä½œæµè§¦å‘æ—¶é—´"
        echo "========================"
        echo "UTC æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "åŒ—äº¬æ—¶é—´: $(TZ="Asia/Shanghai" date '+%Y-%m-%d %H:%M:%S')"
        echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        echo "========================"

    - name: Publish Daily News
      env:
        COZE_TOKEN: ${{ secrets.COZE_TOKEN }}
      run: |
        echo "ğŸš€ å¼€å§‹å‘å¸ƒæ¯æ—¥èµ„è®¯..."
        
        # è°ƒç”¨æ‰£å­API
        response=$(curl -s -w "HTTP_STATUS:%{http_code}" \
          -X POST "https://api.coze.cn/v1/workflow/stream_run" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $COZE_TOKEN" \
          -d '{
            "workflow_id": "7565827159563550756",
            "parameters": {}
          }')
        
        http_status=$(echo "$response" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d':' -f2)
        
        echo "API çŠ¶æ€ç : $http_status"
        
        if [ "$http_status" -eq 200 ]; then
          echo "âœ… æ¯æ—¥èµ„è®¯å‘å¸ƒæˆåŠŸï¼"
          echo "è¯·æ£€æŸ¥ä¼å¾®ç¾¤æ¶ˆæ¯"
        else
          echo "âŒ å‘å¸ƒå¤±è´¥: $http_status"
          # æ˜¾ç¤ºè¯¦ç»†é”™è¯¯
          response_body=$(echo "$response" | sed 's/HTTP_STATUS:[0-9]*//')
          echo "é”™è¯¯è¯¦æƒ…: $response_body"
        fi

    - name: Final Log
      run: |
        echo "ğŸ‰ å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
        echo "â° ä¸‹æ¬¡æ‰§è¡Œ: æ˜å¤© 09:00 (åŒ—äº¬æ—¶é—´)"
