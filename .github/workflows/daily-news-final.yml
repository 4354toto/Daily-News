name: Daily News Auto Publisher

on:
  schedule:
    - cron: '0 1 * * *'  # 每天 UTC 1:00 (北京时间 9:00)
  workflow_dispatch:      # 允许手动触发

jobs:
  publish-daily-news:
    runs-on: ubuntu-latest
    steps:
    - name: Publish Daily News
      env:
        COZE_TOKEN: ${{ secrets.COZE_TOKEN }}
      run: |
        echo "📰 开始发布每日资讯..."
        echo "🕘 北京时间: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        echo "🔐 使用服务访问令牌 (SAT)"
        
        # 触发扣子工作流
        response=$(curl -s -w "HTTP_STATUS:%{http_code}" \
          -X POST "https://api.coze.cn/v1/workflow/stream_run" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $COZE_TOKEN" \
          -d '{
            "workflow_id": "7565827159563550756",
            "parameters": {}
          }')
        
        http_status=$(echo "$response" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d':' -f2)
        response_body=$(echo "$response" | sed 's/HTTP_STATUS:[0-9]*//')
        
        echo "📊 API 响应状态码: $http_status"
        
        if [ "$http_status" -eq 200 ]; then
          echo "✅ 每日资讯发布成功！"
          echo "📱 请检查企微群是否收到消息"
          
          # 检查流式响应中是否有错误
          if echo "$response_body" | grep -q "event: Error"; then
            echo "⚠️ 注意: API 返回成功，但流式响应中包含错误事件"
            echo "详细响应: $response_body"
          fi
        else
          echo "❌ 发布失败，状态码: $http_status"
          echo "错误详情: $response_body"
        fi

    - name: Success Log
      if: success()
      run: |
        echo "🎉 自动化流程执行完成"
        echo "✅ GitHub Actions → 扣子平台 → 企微群"
        echo "⏰ 下次自动执行: 明天 09:00 (北京时间)"
        echo "🔔 如需立即测试，可手动触发工作流"

    - name: Failure Alert
      if: failure()
      run: |
        echo "❌ 执行失败"
        echo "💡 请检查:"
        echo "  1. 扣子平台工作流状态"
        echo "  2. 企微机器人配置"
        echo "  3. Token 是否仍然有效"
