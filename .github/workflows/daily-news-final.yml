name: Daily News Auto Publisher

on:
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤© UTC 1:00 (åŒ—äº¬æ—¶é—´ 9:00)
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  publish-daily-news:
    runs-on: ubuntu-latest
    steps:
    - name: Publish Daily News
      env:
        COZE_TOKEN: ${{ secrets.COZE_TOKEN }}
      run: |
        echo "ğŸ“° å¼€å§‹å‘å¸ƒæ¯æ—¥èµ„è®¯..."
        echo "ğŸ•˜ åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ” ä½¿ç”¨æœåŠ¡è®¿é—®ä»¤ç‰Œ (SAT)"
        
        # è§¦å‘æ‰£å­å·¥ä½œæµ
        response=$(curl -s -w "HTTP_STATUS:%{http_code}" \
          -X POST "https://api.coze.cn/v1/workflow/stream_run" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $COZE_TOKEN" \
          -d '{
            "workflow_id": "7565827159563550756",
            "parameters": {}
          }')
        
        http_status=$(echo "$response" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d':' -f2)
        response_body=$(echo "$response" | sed 's/HTTP_STATUS:[0-9]*//')
        
        echo "ğŸ“Š API å“åº”çŠ¶æ€ç : $http_status"
        
        if [ "$http_status" -eq 200 ]; then
          echo "âœ… æ¯æ—¥èµ„è®¯å‘å¸ƒæˆåŠŸï¼"
          echo "ğŸ“± è¯·æ£€æŸ¥ä¼å¾®ç¾¤æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯"
          
          # æ£€æŸ¥æµå¼å“åº”ä¸­æ˜¯å¦æœ‰é”™è¯¯
          if echo "$response_body" | grep -q "event: Error"; then
            echo "âš ï¸ æ³¨æ„: API è¿”å›æˆåŠŸï¼Œä½†æµå¼å“åº”ä¸­åŒ…å«é”™è¯¯äº‹ä»¶"
            echo "è¯¦ç»†å“åº”: $response_body"
          fi
        else
          echo "âŒ å‘å¸ƒå¤±è´¥ï¼ŒçŠ¶æ€ç : $http_status"
          echo "é”™è¯¯è¯¦æƒ…: $response_body"
        fi

    - name: Success Log
      if: success()
      run: |
        echo "ğŸ‰ è‡ªåŠ¨åŒ–æµç¨‹æ‰§è¡Œå®Œæˆ"
        echo "âœ… GitHub Actions â†’ æ‰£å­å¹³å° â†’ ä¼å¾®ç¾¤"
        echo "â° ä¸‹æ¬¡è‡ªåŠ¨æ‰§è¡Œ: æ˜å¤© 09:00 (åŒ—äº¬æ—¶é—´)"
        echo "ğŸ”” å¦‚éœ€ç«‹å³æµ‹è¯•ï¼Œå¯æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ"

    - name: Failure Alert
      if: failure()
      run: |
        echo "âŒ æ‰§è¡Œå¤±è´¥"
        echo "ğŸ’¡ è¯·æ£€æŸ¥:"
        echo "  1. æ‰£å­å¹³å°å·¥ä½œæµçŠ¶æ€"
        echo "  2. ä¼å¾®æœºå™¨äººé…ç½®"
        echo "  3. Token æ˜¯å¦ä»ç„¶æœ‰æ•ˆ"
