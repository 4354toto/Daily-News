name: Daily News Auto Publisher

on:
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤© UTC 1:00 (åŒ—äº¬æ—¶é—´ 9:00)
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-date:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
    - name: Check if should run today
      id: check
      run: |
        echo "ğŸ“… æ£€æŸ¥ä»Šå¤©æ˜¯å¦éœ€è¦å‘é€..."
        
        # è·å–å½“å‰æ—¥æœŸï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
        CURRENT_DATE=$(TZ="Asia/Shanghai" date +%Y-%m-%d)
        DAY_OF_WEEK=$(TZ="Asia/Shanghai" date +%u)  # 1=å‘¨ä¸€, 7=å‘¨æ—¥
        
        echo "å½“å‰æ—¥æœŸ: $CURRENT_DATE"
        echo "æ˜ŸæœŸå‡ : $DAY_OF_WEEK"
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯å‘¨æœ« (6=å‘¨å…­, 7=å‘¨æ—¥)
        if [ "$DAY_OF_WEEK" -eq 6 ] || [ "$DAY_OF_WEEK" -eq 7 ]; then
          echo "ä»Šå¤©æ˜¯å‘¨æœ«ï¼Œè·³è¿‡æ‰§è¡Œ"
          echo "should-run=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯æ³•å®šèŠ‚å‡æ—¥ï¼ˆä½¿ç”¨èŠ‚å‡æ—¥APIï¼‰
        echo "æ£€æŸ¥æ³•å®šèŠ‚å‡æ—¥..."
        HOLIDAY_RESPONSE=$(curl -s "http://timor.tech/api/holiday/info/$CURRENT_DATE")
        echo "èŠ‚å‡æ—¥APIå“åº”: $HOLIDAY_RESPONSE"
        
        # è§£æAPIå“åº”ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯èŠ‚å‡æ—¥
        IS_HOLIDAY=$(echo "$HOLIDAY_RESPONSE" | grep -o '"holiday":{[^}]*"holiday":true' | wc -l)
        IS_WORKDAY=$(echo "$HOLIDAY_RESPONSE" | grep -o '"holiday":{[^}]*"holiday":false' | wc -l)
        
        if [ "$IS_HOLIDAY" -gt 0 ]; then
          echo "ä»Šå¤©æ˜¯æ³•å®šèŠ‚å‡æ—¥ï¼Œè·³è¿‡æ‰§è¡Œ"
          echo "should-run=false" >> $GITHUB_OUTPUT
        elif [ "$IS_WORKDAY" -gt 0 ]; then
          echo "ä»Šå¤©æ˜¯è°ƒä¼‘å·¥ä½œæ—¥ï¼Œæ­£å¸¸æ‰§è¡Œ"
          echo "should-run=true" >> $GITHUB_OUTPUT
        else
          # å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œé»˜è®¤æŒ‰å·¥ä½œæ—¥å¤„ç†
          echo "èŠ‚å‡æ—¥APIè°ƒç”¨å¤±è´¥ï¼ŒæŒ‰å·¥ä½œæ—¥å¤„ç†"
          echo "should-run=true" >> $GITHUB_OUTPUT
        fi

  publish-daily-news:
    runs-on: ubuntu-latest
    needs: check-date
    if: needs.check-date.outputs.should-run == 'true'
    steps:
    - name: Publish Daily News
      env:
        COZE_TOKEN: ${{ secrets.COZE_TOKEN }}
      run: |
        echo "ğŸ“° å¼€å§‹å‘å¸ƒæ¯æ—¥èµ„è®¯..."
        echo "ğŸ•˜ åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        
        # è§¦å‘æ‰£å­å·¥ä½œæµ
        response=$(curl -s -w "HTTP_STATUS:%{http_code}" \
          -X POST "https://api.coze.cn/v1/workflow/stream_run" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $COZE_TOKEN" \
          -d '{
            "workflow_id": "7565827159563550756",
            "parameters": {}
          }')
        
        http_status=$(echo "$response" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d':' -f2)
        
        echo "API å“åº”çŠ¶æ€ç : $http_status"
        
        if [ "$http_status" -eq 200 ]; then
          echo "âœ… æ¯æ—¥èµ„è®¯å‘å¸ƒæˆåŠŸï¼"
        else
          echo "âŒ å‘å¸ƒå¤±è´¥ï¼ŒçŠ¶æ€ç : $http_status"
          exit 1
        fi

    - name: Success Log
      run: |
        echo "ğŸ‰ å·¥ä½œæ—¥èµ„è®¯å‘å¸ƒå®Œæˆ"
        echo "â° ä¸‹æ¬¡æ£€æŸ¥: æ˜å¤© 09:00"

  skip-execution:
    runs-on: ubuntu-latest
    needs: check-date
    if: needs.check-date.outputs.should-run == 'false'
    steps:
    - name: Log Skip
      run: |
        echo "â¸ï¸ ä»Šæ—¥è·³è¿‡æ‰§è¡Œ"
        echo "åŸå› : å‘¨æœ«æˆ–æ³•å®šèŠ‚å‡æ—¥"
        echo "ğŸ“… ä¸‹æ¬¡æ‰§è¡Œ: ä¸‹ä¸€ä¸ªå·¥ä½œæ—¥ 09:00"
