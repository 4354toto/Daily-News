name: Daily News Auto Publisher

on:
  schedule:
    # ä½¿ç”¨å¤šä¸ªå¤‡ç”¨æ—¶é—´ç‚¹ï¼Œç¡®ä¿è§¦å‘
    - cron: '0 1 * * *'   # ä¸»è§¦å‘: UTC 1:00 (åŒ—äº¬æ—¶é—´ 9:00)
    - cron: '1 1 * * *'   # å¤‡ç”¨1: UTC 1:01 (åŒ—äº¬æ—¶é—´ 9:01)
    - cron: '2 1 * * *'   # å¤‡ç”¨2: UTC 1:02 (åŒ—äº¬æ—¶é—´ 9:02)
  workflow_dispatch:       # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]    # ä»£ç æ¨é€æ—¶ä¹Ÿè§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰

jobs:
  date-check:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
      current-date: ${{ steps.date.outputs.current-date }}
      day-of-week: ${{ steps.date.outputs.day-of-week }}
    steps:
    - name: Get Beijing Time
      id: date
      run: |
        CURRENT_DATE=$(TZ="Asia/Shanghai" date +%Y-%m-%d)
        DAY_OF_WEEK=$(TZ="Asia/Shanghai" date +%u)
        echo "current-date=$CURRENT_DATE" >> $GITHUB_OUTPUT
        echo "day-of-week=$DAY_OF_WEEK" >> $GITHUB_OUTPUT
        echo "ğŸ•’ åŒ—äº¬æ—¶é—´: $(TZ="Asia/Shanghai" date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ“… æ—¥æœŸ: $CURRENT_DATE"
        echo "ğŸ“† æ˜ŸæœŸ: $DAY_OF_WEEK (1=å‘¨ä¸€, 7=å‘¨æ—¥)"

    - name: Check if Workday
      id: check
      run: |
        # å‘¨æœ«ä¸æ‰§è¡Œ (6=å‘¨å…­, 7=å‘¨æ—¥)
        if [ "${{ steps.date.outputs.day-of-week }}" -eq 6 ] || [ "${{ steps.date.outputs.day-of-week }}" -eq 7 ]; then
          echo "â›” ä»Šå¤©æ˜¯å‘¨æœ«ï¼Œè·³è¿‡æ‰§è¡Œ"
          echo "should-run=false" >> $GITHUB_OUTPUT
        else
          echo "âœ… ä»Šå¤©æ˜¯å·¥ä½œæ—¥ï¼Œæ‰§è¡Œæ¯æ—¥èµ„è®¯"
          echo "should-run=true" >> $GITHUB_OUTPUT
        fi

  publish-news:
    runs-on: ubuntu-latest
    needs: date-check
    if: needs.date-check.outputs.should-run == 'true'
    steps:
    - name: Trigger Coze Workflow
      env:
        COZE_TOKEN: ${{ secrets.COZE_TOKEN }}
      run: |
        echo "ğŸš€ å¼€å§‹å‘å¸ƒæ¯æ—¥èµ„è®¯..."
        echo "ğŸ“… æ‰§è¡Œæ—¥æœŸ: ${{ needs.date-check.outputs.current-date }}"
        echo "ğŸ•˜ åŒ—äº¬æ—¶é—´: $(TZ="Asia/Shanghai" date '+%H:%M:%S')"
        
        # è°ƒç”¨æ‰£å­API
        response=$(curl -s -w "HTTP_STATUS:%{http_code}" \
          -X POST "https://api.coze.cn/v1/workflow/stream_run" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $COZE_TOKEN" \
          -d '{
            "workflow_id": "7565827159563550756",
            "parameters": {}
          }')
        
        http_status=$(echo "$response" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d':' -f2)
        response_body=$(echo "$response" | sed 's/HTTP_STATUS:[0-9]*//')
        
        echo "ğŸ“Š APIå“åº”ç : $http_status"
        
        if [ "$http_status" -eq 200 ]; then
          echo "âœ… æ¯æ—¥èµ„è®¯å‘å¸ƒæˆåŠŸï¼"
          echo "è¯·æ£€æŸ¥ä¼å¾®ç¾¤æ¶ˆæ¯"
        else
          echo "âŒ å‘å¸ƒå¤±è´¥: $http_status"
          echo "é”™è¯¯è¯¦æƒ…: $response_body"
          # ä¸é€€å‡ºï¼Œç»§ç»­è®°å½•
        fi

    - name: Log Success
      run: |
        echo "ğŸ‰ å·¥ä½œæ—¥èµ„è®¯å‘å¸ƒå®Œæˆ"
        echo "â° ä¸‹æ¬¡æ‰§è¡Œ: æ˜å¤© 09:00 (åŒ—äº¬æ—¶é—´)"

  skip-notification:
    runs-on: ubuntu-latest
    needs: date-check
    if: needs.date-check.outputs.should-run == 'false'
    steps:
    - name: Log Weekend Skip
      run: |
        echo "â¸ï¸ ä»Šæ—¥ä¼‘æ¯ï¼Œä¸å‘é€èµ„è®¯"
        echo "ğŸ“… æ—¥æœŸ: ${{ needs.date-check.outputs.current-date }}"
        echo "ğŸ“† åŸå› : å‘¨æœ«"
        echo "ğŸ”„ ä¸‹æ¬¡å·¥ä½œæ—¥æ‰§è¡Œ: æ˜å¤© 09:00"

  final-log:
    runs-on: ubuntu-latest
    needs: [publish-news, skip-notification]
    steps:
    - name: Workflow Complete
      run: |
        echo "ğŸ GitHub Actions å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
        echo "âœ… æ‰€æœ‰æ­¥éª¤å·²å¤„ç†"
        echo "ğŸ“Š æŸ¥çœ‹è¯¦æƒ…: https://github.com/$GITHUB_REPOSITORY/actions"
