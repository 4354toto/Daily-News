name: Daily News Workflow

on:
  schedule:
    - cron: '0 1 * * *'  # 每天UTC 1:00 (北京时间9:00)
  workflow_dispatch:

jobs:
  trigger-coze:
    runs-on: ubuntu-latest
    steps:
    - name: Verify Token and Environment
      run: |
        echo "=== 环境验证 ==="
        echo "Runner OS: $RUNNER_OS"
        echo "Token长度: ${#COZE_TOKEN}"
        echo "Token前6位: ${COZE_TOKEN:0:6}"
        echo "Token后6位: ${COZE_TOKEN: -6}"
        echo "工作流ID: 7565827159563550756"
        echo "API端点: https://api.coze.cn/v1/workflow/stream_run"

    - name: Test API with Detailed Response
      run: |
        echo "=== 测试API调用 ==="
        
        # 使用更详细的curl命令
        curl -v -X POST "https://api.coze.cn/v1/workflow/stream_run" \
          -H "Authorization: Bearer ${{ secrets.COZE_TOKEN }}" \
          -H "Content-Type: application/json" \
          -H "Accept: application/json" \
          -d '{"workflow_id": "7565827159563550756", "parameters": {}}' \
          -o response_body.txt \
          -w "HTTP_STATUS:%{http_code}" \
          2> curl_log.txt
        
        # 读取HTTP状态码
        HTTP_CODE=$(grep -o 'HTTP_STATUS:[0-9]*' curl_log.txt | cut -d':' -f2)
        echo "HTTP状态码: $HTTP_CODE"
        
        # 显示详细日志
        echo "=== cURL详细日志 ==="
        cat curl_log.txt
        
        # 显示响应体
        echo "=== 响应体 ==="
        if [ -f "response_body.txt" ]; then
          cat response_body.txt
          echo ""
        else
          echo "无响应体"
        fi
        
        # 清理临时文件
        rm -f response_body.txt curl_log.txt
        
        # 根据状态码判断结果
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "✅ API调用成功！"
          echo "注意：如果企微群未收到消息，请检查扣子平台工作流配置"
          exit 0
        else
          echo "❌ API调用失败，状态码: $HTTP_CODE"
          exit 1
        fi

    - name: Success Notification
      if: success()
      run: |
        echo "🎉 GitHub Actions 执行成功！"
        echo "执行时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "北京时间: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        echo ""
        echo "⚠️ 如果企微群未收到消息，请检查："
        echo "1. 扣子平台工作流中的企微机器人配置"
        echo "2. 企微群机器人的Webhook地址"
        echo "3. 工作流执行日志"

    - name: Failure Notification
      if: failure()
      run: |
        echo "❌ GitHub Actions 执行失败"
        echo "失败时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
