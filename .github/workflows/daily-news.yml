name: Daily News Workflow

on:
  schedule:
    - cron: '0 1 * * *'  # 每天UTC 1:00 (北京时间9:00)
  workflow_dispatch:

jobs:
  trigger-coze:
    runs-on: ubuntu-latest
    steps:
    - name: Verify Token and Environment
      run: |
        echo "=== 环境验证 ==="
        echo "Runner OS: $RUNNER_OS"
        echo "Token长度: ${#COZE_TOKEN}"
        echo "Token前6位: ${COZE_TOKEN:0:6}"
        echo "Token后6位: ${COZE_TOKEN: -6}"
        echo "工作流ID: 7565827159563550756"
        echo "API端点: https://api.coze.cn/v1/workflow/stream_run"

    - name: Test API with New Token
      run: |
        echo "=== 测试API调用 ==="
        
        # 创建请求数据
        REQUEST_DATA='{"workflow_id": "7565827159563550756", "parameters": {}}'
        
        # 发送请求并捕获完整响应
        HTTP_RESPONSE=$(curl -s -w "HTTP_CODE:%{http_code}" \
          -X POST "https://api.coze.cn/v1/workflow/stream_run" \
          -H "Authorization: Bearer ${{ secrets.COZE_TOKEN }}" \
          -H "Content-Type: application/json" \
          -H "Accept: application/json" \
          -d "$REQUEST_DATA")
        
        # 分离HTTP状态码和响应体
        HTTP_CODE=$(echo "$HTTP_RESPONSE" | grep -o 'HTTP_CODE:[0-9]*' | cut -d':' -f2)
        RESPONSE_BODY=$(echo "$HTTP_RESPONSE" | sed 's/HTTP_CODE:[0-9]*//')
        
        echo "HTTP状态码: $HTTP_CODE"
        echo "响应内容: $RESPONSE_BODY"
        
        # 根据状态码判断结果
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "✅ 工作流触发成功！"
          echo "success" > result.txt
          exit 0
        elif [ "$HTTP_CODE" -eq 401 ]; then
          echo "❌ 认证失败 (401)"
          echo "请检查："
          echo "1. Token权限是否正确"
          echo "2. Token是否已启用"
          echo "3. 工作流ID是否正确"
          exit 1
        else
          echo "❌ 请求失败，状态码: $HTTP_CODE"
          exit 1
        fi

    - name: Success Notification
      if: success()
      run: |
        echo "🎉 每日资讯工作流执行成功！"
        echo "执行时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "北京时间: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"

    - name: Failure Notification
      if: failure()
      run: |
        echo "⚠️ 工作流执行失败"
        echo "失败时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "建议检查："
        echo "1. 在扣子平台验证Token权限"
        echo "2. 确认工作流ID正确"
        echo "3. 检查网络连接"
