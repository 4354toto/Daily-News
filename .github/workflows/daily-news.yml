name: Daily News - Simple & Reliable

on:
  schedule:
    - cron: '0 1 * * *'  # 每天UTC 1:00 (北京时间9:00)
  workflow_dispatch:

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
    - name: Pre-check
      run: |
        echo "工作流ID: 756220938248711374"
        echo "Token可用性: $([ -n "$COZE_TOKEN" ] && echo "已设置" || echo "未设置")"
        echo "Token长度: ${#COZE_TOKEN}"

    - name: Trigger Workflow
      run: |
        # 使用最简化的curl命令
        response=$(curl -s -w "|HTTP_CODE:%{http_code}" \
          -X POST "https://api.coze.cn/v1/workflow/stream_run" \
          -H "Authorization: Bearer $COZE_TOKEN" \
          -H "Content-Type: application/json" \
          -d '{"workflow_id": "756220938248711374", "parameters": {}}')
        
        # 分离响应体和状态码
        http_code=$(echo "$response" | grep -o 'HTTP_CODE:[0-9]*' | cut -d':' -f2)
        response_body=$(echo "$response" | sed 's/|HTTP_CODE:[0-9]*//')
        
        echo "状态码: $http_code"
        echo "响应: $response_body"
        
        if [ "$http_code" -eq 200 ]; then
          echo "✅ API调用成功"
          # 检查响应内容是否有错误
          if echo "$response_body" | grep -q "error_code"; then
            echo "⚠️ 响应中包含错误信息，但HTTP状态为200"
            echo "详细错误: $response_body"
            exit 0  # 仍然算成功，因为HTTP 200
          else
            echo "🎉 工作流触发成功"
            exit 0
          fi
        else
          echo "❌ API调用失败: $http_code"
          exit 1
        fi

    - name: Success
      if: success()
      run: |
        echo "✅ 每日资讯工作流已触发"
        echo "时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "请检查扣子平台执行日志和企微群消息"

    - name: Failure
      if: failure()
      run: |
        echo "❌ 执行失败"
        echo "请检查:"
        echo "1. Token是否有效且有权跟"
        echo "2. 工作流ID是否正确"
        echo "3. 网络连接是否正常"
