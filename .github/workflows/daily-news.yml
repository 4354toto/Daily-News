name: Daily News Workflow

on:
  schedule:
    - cron: '0 1 * * *'  # 每天UTC 1:00 (北京时间9:00)
  workflow_dispatch:

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
    - name: Pre-check
      run: |
        echo "工作流ID: 756220938248711374"
        echo "Token长度: ${#COZE_TOKEN}"

    - name: Trigger Workflow with Correct Prefix
      run: |
        echo "=== 使用正确的Authorization前缀 ==="
        
        # 方法1: 使用正确的Bearer前缀
        response=$(curl -s -w "|HTTP_CODE:%{http_code}" \
          -X POST "https://api.coze.cn/v1/workflow/stream_run" \
          -H "Authorization: Bearer $COZE_TOKEN" \
          -H "Content-Type: application/json" \
          -d '{"workflow_id": "756220938248711374", "parameters": {}}')
        
        http_code=$(echo "$response" | grep -o 'HTTP_CODE:[0-9]*' | cut -d':' -f2)
        response_body=$(echo "$response" | sed 's/|HTTP_CODE:[0-9]*//')
        
        echo "状态码: $http_code"
        echo "响应: $response_body"
        
        if [ "$http_code" -eq 200 ]; then
          echo "✅ API调用成功"
          # 检查是否是流式响应
          if echo "$response_body" | grep -q "event:"; then
            echo "📡 收到流式响应，处理中..."
            # 解析流式响应
            if echo "$response_body" | grep -q "event: Error"; then
              echo "❌ 流式响应中包含错误"
              exit 1
            else
              echo "✅ 工作流触发成功"
              exit 0
            fi
          else
            echo "✅ 工作流触发成功"
            exit 0
          fi
        else
          echo "❌ API调用失败: $http_code"
          exit 1
        fi

    - name: Success
      if: success()
      run: |
        echo "✅ 每日资讯工作流已触发"
        echo "时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "北京时间: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        echo "请检查扣子平台执行日志和企微群消息"

    - name: Failure
      if: failure()
      run: |
        echo "❌ 执行失败"
        echo "请检查Token权限和工作流配置"
