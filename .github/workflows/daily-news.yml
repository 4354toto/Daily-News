name: Daily News Workflow

on:
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©UTC 1:00 (åŒ—äº¬æ—¶é—´9:00)
  workflow_dispatch:

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
    - name: Pre-check
      run: |
        echo "å·¥ä½œæµID: 756220938248711374"
        echo "Tokené•¿åº¦: ${#COZE_TOKEN}"

    - name: Trigger Workflow with Correct Prefix
      run: |
        echo "=== ä½¿ç”¨æ­£ç¡®çš„Authorizationå‰ç¼€ ==="
        
        # æ–¹æ³•1: ä½¿ç”¨æ­£ç¡®çš„Bearerå‰ç¼€
        response=$(curl -s -w "|HTTP_CODE:%{http_code}" \
          -X POST "https://api.coze.cn/v1/workflow/stream_run" \
          -H "Authorization: Bearer $COZE_TOKEN" \
          -H "Content-Type: application/json" \
          -d '{"workflow_id": "756220938248711374", "parameters": {}}')
        
        http_code=$(echo "$response" | grep -o 'HTTP_CODE:[0-9]*' | cut -d':' -f2)
        response_body=$(echo "$response" | sed 's/|HTTP_CODE:[0-9]*//')
        
        echo "çŠ¶æ€ç : $http_code"
        echo "å“åº”: $response_body"
        
        if [ "$http_code" -eq 200 ]; then
          echo "âœ… APIè°ƒç”¨æˆåŠŸ"
          # æ£€æŸ¥æ˜¯å¦æ˜¯æµå¼å“åº”
          if echo "$response_body" | grep -q "event:"; then
            echo "ğŸ“¡ æ”¶åˆ°æµå¼å“åº”ï¼Œå¤„ç†ä¸­..."
            # è§£ææµå¼å“åº”
            if echo "$response_body" | grep -q "event: Error"; then
              echo "âŒ æµå¼å“åº”ä¸­åŒ…å«é”™è¯¯"
              exit 1
            else
              echo "âœ… å·¥ä½œæµè§¦å‘æˆåŠŸ"
              exit 0
            fi
          else
            echo "âœ… å·¥ä½œæµè§¦å‘æˆåŠŸ"
            exit 0
          fi
        else
          echo "âŒ APIè°ƒç”¨å¤±è´¥: $http_code"
          exit 1
        fi

    - name: Success
      if: success()
      run: |
        echo "âœ… æ¯æ—¥èµ„è®¯å·¥ä½œæµå·²è§¦å‘"
        echo "æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        echo "è¯·æ£€æŸ¥æ‰£å­å¹³å°æ‰§è¡Œæ—¥å¿—å’Œä¼å¾®ç¾¤æ¶ˆæ¯"

    - name: Failure
      if: failure()
      run: |
        echo "âŒ æ‰§è¡Œå¤±è´¥"
        echo "è¯·æ£€æŸ¥Tokenæƒé™å’Œå·¥ä½œæµé…ç½®"
