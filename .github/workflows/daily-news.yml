name: Daily News Workflow - Enhanced

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
    - name: Trigger with Multiple Auth Methods
      run: |
        echo "=== å°è¯•å¤šç§è®¤è¯æ–¹æ³• ==="
        
        # æ–¹æ³•1: æ ‡å‡†Bearerå‰ç¼€
        echo "æ–¹æ³•1: Bearerå‰ç¼€"
        response1=$(curl -s -w "|HTTP_CODE:%{http_code}" \
          -X POST "https://api.coze.cn/v1/workflow/stream_run" \
          -H "Authorization: Bearer $COZE_TOKEN" \
          -H "Content-Type: application/json" \
          -d '{"workflow_id": "756220938248711374", "parameters": {}}')
        
        code1=$(echo "$response1" | grep -o 'HTTP_CODE:[0-9]*' | cut -d':' -f2)
        body1=$(echo "$response1" | sed 's/|HTTP_CODE:[0-9]*//')
        
        echo "æ–¹æ³•1çŠ¶æ€ç : $code1"
        
        if [ "$code1" -eq 200 ]; then
          echo "âœ… æ–¹æ³•1æˆåŠŸ"
          echo "å“åº”: $body1"
          exit 0
        fi
        
        # æ–¹æ³•2: å°è¯•å…¶ä»–å¯èƒ½çš„å‰ç¼€
        echo "æ–¹æ³•2: å°è¯•å…¶ä»–å‰ç¼€"
        prefixes=("Bearer" "Token" "Coze" "APIKey")
        
        for prefix in "${prefixes[@]}"; do
          echo "å°è¯•å‰ç¼€: $prefix"
          response=$(curl -s -w "|HTTP_CODE:%{http_code}" \
            -X POST "https://api.coze.cn/v1/workflow/stream_run" \
            -H "Authorization: $prefix $COZE_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"workflow_id": "756220938248711374", "parameters": {}}')
          
          code=$(echo "$response" | grep -o 'HTTP_CODE:[0-9]*' | cut -d':' -f2)
          body=$(echo "$response" | sed 's/|HTTP_CODE:[0-9]*//')
          
          echo "$prefix çŠ¶æ€ç : $code"
          
          if [ "$code" -eq 200 ]; then
            echo "âœ… ä½¿ç”¨å‰ç¼€ '$prefix' æˆåŠŸ"
            echo "å“åº”: $body"
            exit 0
          fi
        done
        
        echo "âŒ æ‰€æœ‰è®¤è¯æ–¹æ³•éƒ½å¤±è´¥"
        echo "æœ€åé”™è¯¯å“åº”: $body1"
        exit 1

    - name: Success
      if: success()
      run: |
        echo "ğŸ‰ å·¥ä½œæµè§¦å‘æˆåŠŸ"
        echo "æ‰§è¡Œæ—¶é—´: $(date)"

    - name: Failure
      if: failure()
      run: |
        echo "âŒ å·¥ä½œæµè§¦å‘å¤±è´¥"
        echo "å¯èƒ½åŸå› :"
        echo "1. Tokenæƒé™ä¸è¶³"
        echo "2. å·¥ä½œæµIDé”™è¯¯"
        echo "3. APIç«¯ç‚¹å˜æ›´"
