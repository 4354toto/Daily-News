name: Daily News Workflow

on:
  schedule:
    - cron: '0 1 * * *'  # 每天UTC 1:00 (北京时间9:00)
  workflow_dispatch:

jobs:
  trigger-coze:
    runs-on: ubuntu-latest
    steps:
    - name: Check Token and Config
      run: |
        echo "Token preview: ...${COZE_TOKEN: -8}"
        echo "Workflow ID: 7565827159563550756"
        echo "API Endpoint: https://api.coze.cn/v1/workflow/stream_run"

    - name: Trigger Coze Workflow
      run: |
        # 使用简单的curl命令
        response=$(curl -s -o response_body.txt -w "%{http_code}" \
          -X POST "https://api.coze.cn/v1/workflow/stream_run" \
          -H "Authorization: Bearer ${{ secrets.COZE_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{"workflow_id": "7565827159563550756", "parameters": {}}')
        
        echo "HTTP Status Code: $response"
        
        if [ -f "response_body.txt" ]; then
          echo "Response Body:"
          cat response_body.txt
          rm response_body.txt
        fi
        
        if [ "$response" -eq 200 ]; then
          echo "✅ 工作流触发成功"
          exit 0
        else
          echo "❌ 工作流触发失败，状态码: $response"
          exit 1
        fi

    - name: Notify Success
      if: success()
      run: |
        echo "🎉 每日资讯工作流执行成功！"
        echo "执行时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

    - name: Notify Failure
      if: failure()
      run: |
        echo "❌ 每日资讯工作流执行失败"
        echo "失败时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "请检查 Token 权限和工作流配置"
