name: Daily News Workflow

on:
  schedule:
    # 每天北京时间9点运行 (UTC+8 = UTC 1:00)
    - cron: '0 1 * * *'
  workflow_dispatch:  # 允许手动触发
  push:
    branches: [ main ]

jobs:
  trigger-coze:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Trigger Coze Workflow
      run: |
        response=$(curl -s -w "HTTP_STATUS:%{http_code}" -X POST "https://api.coze.cn/v1/workflow/stream_run" \
          -H "Authorization: Bearer ${{ secrets.COZE_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "workflow_id": "7565827159563550756",
            "parameters": {}
          }')
        
        # 提取HTTP状态码和响应体
        http_status=$(echo "$response" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d':' -f2)
        body=$(echo "$response" | sed 's/HTTP_STATUS:[0-9]*//g')
        
        echo "HTTP Status: $http_status"
        echo "Response: $body"
        
        # 检查是否成功
        if [ "$http_status" -eq 200 ]; then
          echo "✅ 工作流触发成功"
          exit 0
        else
          echo "❌ 工作流触发失败，状态码: $http_status"
          exit 1
        fi

    - name: Send Notification on Failure
      if: failure()
      run: |
        echo "工作流执行失败，请检查日志"
