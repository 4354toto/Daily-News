name: Daily News - Simple & Reliable

on:
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©UTC 1:00 (åŒ—äº¬æ—¶é—´9:00)
  workflow_dispatch:

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
    - name: Pre-check
      run: |
        echo "å·¥ä½œæµID: 756220938248711374"
        echo "Tokenå¯ç”¨æ€§: $([ -n "$COZE_TOKEN" ] && echo "å·²è®¾ç½®" || echo "æœªè®¾ç½®")"
        echo "Tokené•¿åº¦: ${#COZE_TOKEN}"

    - name: Trigger Workflow
      run: |
        # ä½¿ç”¨æœ€ç®€åŒ–çš„curlå‘½ä»¤
        response=$(curl -s -w "|HTTP_CODE:%{http_code}" \
          -X POST "https://api.coze.cn/v1/workflow/stream_run" \
          -H "Authorization: Bearer $COZE_TOKEN" \
          -H "Content-Type: application/json" \
          -d '{"workflow_id": "756220938248711374", "parameters": {}}')
        
        # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
        http_code=$(echo "$response" | grep -o 'HTTP_CODE:[0-9]*' | cut -d':' -f2)
        response_body=$(echo "$response" | sed 's/|HTTP_CODE:[0-9]*//')
        
        echo "çŠ¶æ€ç : $http_code"
        echo "å“åº”: $response_body"
        
        if [ "$http_code" -eq 200 ]; then
          echo "âœ… APIè°ƒç”¨æˆåŠŸ"
          # æ£€æŸ¥å“åº”å†…å®¹æ˜¯å¦æœ‰é”™è¯¯
          if echo "$response_body" | grep -q "error_code"; then
            echo "âš ï¸ å“åº”ä¸­åŒ…å«é”™è¯¯ä¿¡æ¯ï¼Œä½†HTTPçŠ¶æ€ä¸º200"
            echo "è¯¦ç»†é”™è¯¯: $response_body"
            exit 0  # ä»ç„¶ç®—æˆåŠŸï¼Œå› ä¸ºHTTP 200
          else
            echo "ğŸ‰ å·¥ä½œæµè§¦å‘æˆåŠŸ"
            exit 0
          fi
        else
          echo "âŒ APIè°ƒç”¨å¤±è´¥: $http_code"
          exit 1
        fi

    - name: Success
      if: success()
      run: |
        echo "âœ… æ¯æ—¥èµ„è®¯å·¥ä½œæµå·²è§¦å‘"
        echo "æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "è¯·æ£€æŸ¥æ‰£å­å¹³å°æ‰§è¡Œæ—¥å¿—å’Œä¼å¾®ç¾¤æ¶ˆæ¯"

    - name: Failure
      if: failure()
      run: |
        echo "âŒ æ‰§è¡Œå¤±è´¥"
        echo "è¯·æ£€æŸ¥:"
        echo "1. Tokenæ˜¯å¦æœ‰æ•ˆä¸”æœ‰æƒè·Ÿ"
        echo "2. å·¥ä½œæµIDæ˜¯å¦æ­£ç¡®"
        echo "3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸"
