name: Daily News Workflow - Fetch Version

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Trigger with Fetch API
      env:
        COZE_TOKEN: ${{ secrets.COZE_TOKEN }}
      run: |
        node -e "
        async function triggerWorkflow() {
          try {
            console.log('开始触发工作流...');
            
            const response = await fetch('https://api.coze.cn/v1/workflow/stream_run', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                // 注意：这里使用SDK可能使用的认证头
                'Authorization': \`Bearer \${process.env.COZE_TOKEN}\`
              },
              body: JSON.stringify({
                workflow_id: '7562209382487113774',
                parameters: {
                  input: 'https://auto.163.com/'
                }
              })
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(\`HTTP \${response.status}: \${errorText}\`);
            }

            // 处理流式响应
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              
              const chunk = decoder.decode(value);
              console.log('收到数据:', chunk);
              
              // 检查是否有错误
              if (chunk.includes('event: Error')) {
                throw new Error('流式响应中包含错误事件');
              }
            }

            console.log('✅ 工作流触发成功！');
            
          } catch (error) {
            console.error('❌ 工作流触发失败:');
            console.error('错误信息:', error.message);
            process.exit(1);
          }
        }

        triggerWorkflow();
        "

    - name: Success
      if: success()
      run: |
        echo "✅ 工作流触发成功"
        echo "已处理: https://auto.163.com/"
