name: Daily News Workflow - Enhanced

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
    - name: Trigger with Multiple Auth Methods
      run: |
        echo "=== 尝试多种认证方法 ==="
        
        # 方法1: 标准Bearer前缀
        echo "方法1: Bearer前缀"
        response1=$(curl -s -w "|HTTP_CODE:%{http_code}" \
          -X POST "https://api.coze.cn/v1/workflow/stream_run" \
          -H "Authorization: Bearer $COZE_TOKEN" \
          -H "Content-Type: application/json" \
          -d '{"workflow_id": "756220938248711374", "parameters": {}}')
        
        code1=$(echo "$response1" | grep -o 'HTTP_CODE:[0-9]*' | cut -d':' -f2)
        body1=$(echo "$response1" | sed 's/|HTTP_CODE:[0-9]*//')
        
        echo "方法1状态码: $code1"
        
        if [ "$code1" -eq 200 ]; then
          echo "✅ 方法1成功"
          echo "响应: $body1"
          exit 0
        fi
        
        # 方法2: 尝试其他可能的前缀
        echo "方法2: 尝试其他前缀"
        prefixes=("Bearer" "Token" "Coze" "APIKey")
        
        for prefix in "${prefixes[@]}"; do
          echo "尝试前缀: $prefix"
          response=$(curl -s -w "|HTTP_CODE:%{http_code}" \
            -X POST "https://api.coze.cn/v1/workflow/stream_run" \
            -H "Authorization: $prefix $COZE_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"workflow_id": "756220938248711374", "parameters": {}}')
          
          code=$(echo "$response" | grep -o 'HTTP_CODE:[0-9]*' | cut -d':' -f2)
          body=$(echo "$response" | sed 's/|HTTP_CODE:[0-9]*//')
          
          echo "$prefix 状态码: $code"
          
          if [ "$code" -eq 200 ]; then
            echo "✅ 使用前缀 '$prefix' 成功"
            echo "响应: $body"
            exit 0
          fi
        done
        
        echo "❌ 所有认证方法都失败"
        echo "最后错误响应: $body1"
        exit 1

    - name: Success
      if: success()
      run: |
        echo "🎉 工作流触发成功"
        echo "执行时间: $(date)"

    - name: Failure
      if: failure()
      run: |
        echo "❌ 工作流触发失败"
        echo "可能原因:"
        echo "1. Token权限不足"
        echo "2. 工作流ID错误"
        echo "3. API端点变更"
