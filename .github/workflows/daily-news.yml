name: Daily News Workflow

on:
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©UTC 1:00 (åŒ—äº¬æ—¶é—´9:00)
  workflow_dispatch:

jobs:
  trigger-coze:
    runs-on: ubuntu-latest
    steps:
    - name: Verify Configuration
      run: |
        echo "=== é…ç½®éªŒè¯ ==="
        echo "å·¥ä½œæµID: 756220938248711374"
        echo "Tokené¢„è§ˆ: ...${COZE_TOKEN: -8}"
        echo "APIç«¯ç‚¹: https://api.coze.cn/v1/workflow/stream_run"
        echo "æ‰§è¡Œæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

    - name: Trigger Workflow with Stream Handling
      id: trigger
      run: |
        echo "=== è§¦å‘å·¥ä½œæµ ==="
        
        # ä½¿ç”¨Pythonå¤„ç†æµå¼å“åº”
        python3 << 'EOF'
        import requests
        import json
        import os
        import sys
        
        # é…ç½®
        token = os.environ.get('COZE_TOKEN')
        workflow_id = "756220938248711374"
        url = "https://api.coze.cn/v1/workflow/stream_run"
        
        headers = {
            "Authorization": f"Bearer {token}",
            "Content-Type": "application/json",
            "Accept": "text/event-stream"
        }
        
        data = {
            "workflow_id": workflow_id,
            "parameters": {}
        }
        
        print(f"å‘é€è¯·æ±‚åˆ°: {url}")
        print(f"å·¥ä½œæµID: {workflow_id}")
        
        try:
            response = requests.post(url, json=data, headers=headers, stream=True, timeout=30)
            print(f"HTTPçŠ¶æ€ç : {response.status_code}")
            
            if response.status_code != 200:
                print(f"âŒ è¯·æ±‚å¤±è´¥: {response.status_code}")
                print(f"å“åº”: {response.text}")
                sys.exit(1)
            
            # å¤„ç†æµå¼å“åº”
            success = False
            error_detected = False
            
            for line in response.iter_lines(decode_unicode=True):
                if line:
                    print(f"æ”¶åˆ°: {line}")
                    
                    if line.startswith('event:'):
                        event_type = line.replace('event:', '').strip()
                        if event_type == 'Error':
                            error_detected = True
                        elif event_type in ['Success', 'Complete', 'Done']:
                            success = True
                    
                    elif line.startswith('data:'):
                        data_content = line.replace('data:', '').strip()
                        if data_content:
                            try:
                                data_json = json.loads(data_content)
                                if 'error_code' in data_json:
                                    print(f"âŒ é”™è¯¯ä»£ç : {data_json['error_code']}")
                                    print(f"é”™è¯¯ä¿¡æ¯: {data_json.get('error_message', 'æ— è¯¦ç»†ä¿¡æ¯')}")
                                    error_detected = True
                                elif 'status' in data_json and data_json['status'] == 'success':
                                    success = True
                            except json.JSONDecodeError:
                                print(f"æ•°æ®å†…å®¹: {data_content}")
            
            if error_detected:
                print("âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥")
                sys.exit(1)
            elif success:
                print("âœ… å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ")
                sys.exit(0)
            else:
                print("âš ï¸ æ— æ³•ç¡®å®šæ‰§è¡Œç»“æœï¼Œè¯·æ£€æŸ¥æ‰£å­å¹³å°æ—¥å¿—")
                # å¦‚æœæ²¡æœ‰æ˜ç¡®é”™è¯¯ï¼Œè®¤ä¸ºæ˜¯æˆåŠŸ
                sys.exit(0)
                
        except requests.exceptions.RequestException as e:
            print(f"âŒ è¯·æ±‚å¼‚å¸¸: {e}")
            sys.exit(1)
        EOF

    - name: Check Result
      run: |
        echo "ä¸Šä¸€æ­¥é€€å‡ºä»£ç : ${{ steps.trigger.outcome }}"
        if [ "${{ steps.trigger.outcome }}" == "success" ]; then
          echo "âœ… å·¥ä½œæµè§¦å‘æˆåŠŸ"
        else
          echo "âŒ å·¥ä½œæµè§¦å‘å¤±è´¥"
        fi

    - name: Success Notification
      if: success()
      run: |
        echo "ğŸ‰ æ¯æ—¥èµ„è®¯å·¥ä½œæµæ‰§è¡ŒæˆåŠŸï¼"
        echo "æ‰§è¡Œæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        echo ""
        echo "âœ… GitHub Actions å·²æˆåŠŸè§¦å‘æ‰£å­å·¥ä½œæµ"
        echo "ğŸ“± è¯·æ£€æŸ¥ä¼å¾®ç¾¤æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯"

    - name: Failure Notification
      if: failure()
      run: |
        echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥"
        echo "å¤±è´¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        echo "å¯èƒ½çš„åŸå› ï¼š"
        echo "1. Token æ²¡æœ‰å·¥ä½œæµæ‰§è¡Œæƒé™"
        echo "2. å·¥ä½œæµ ID ä¸æ­£ç¡®"
        echo "3. å·¥ä½œæµæœªå‘å¸ƒæˆ–å·²ç¦ç”¨"
        echo "4. ç½‘ç»œè¿æ¥é—®é¢˜"
        echo ""
        echo "è¯·æ£€æŸ¥ï¼š"
        echo "- æ‰£å­å¹³å° Token æƒé™è®¾ç½®"
        echo "- å·¥ä½œæµ ID æ˜¯å¦æ­£ç¡®"
        echo "- å·¥ä½œæµæ˜¯å¦å·²å‘å¸ƒ"
