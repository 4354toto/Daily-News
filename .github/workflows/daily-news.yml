name: Daily News Workflow

on:
  schedule:
    - cron: '0 1 * * *'  # 每天UTC 1:00 (北京时间9:00)
  workflow_dispatch:

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Coze SDK
      run: |
        npm install @coze/api

    - name: Trigger Coze Workflow
      env:
        COZE_TOKEN: ${{ secrets.COZE_TOKEN }}
      run: |
        node -e "
        const { CozeAPI } = require('@coze/api');

        async function triggerWorkflow() {
          try {
            console.log('开始触发工作流...');
            
            const apiClient = new CozeAPI({
              token: process.env.COZE_TOKEN,
              baseURL: 'https://api.coze.cn'
            });

            const res = await apiClient.workflows.runs.stream({
              workflow_id: '7562209382487113774',
              parameters: {
                input: 'https://auto.163.com/'
              }
            });

            console.log('✅ 工作流触发成功！');
            console.log('响应:', JSON.stringify(res, null, 2));
            
          } catch (error) {
            console.error('❌ 工作流触发失败:');
            console.error('错误信息:', error.message);
            if (error.response) {
              console.error('状态码:', error.response.status);
              console.error('响应数据:', error.response.data);
            }
            process.exit(1);
          }
        }

        triggerWorkflow();
        "

    - name: Success Notification
      if: success()
      run: |
        echo "🎉 每日资讯工作流执行成功！"
        echo "执行时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "北京时间: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        echo "已触发工作流 ID: 7562209382487113774"
        echo "输入参数: https://auto.163.com/"

    - name: Failure Notification
      if: failure()
      run: |
        echo "❌ 工作流执行失败"
        echo "失败时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "请检查:"
        echo "1. Token权限设置"
        echo "2. 工作流ID是否正确"
        echo "3. 网络连接"
