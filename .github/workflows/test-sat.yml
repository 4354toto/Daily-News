name: Test Service Access Token

on:
  workflow_dispatch:

jobs:
  test-sat:
    runs-on: ubuntu-latest
    steps:
    - name: Test SAT Token
      env:
        COZE_TOKEN: ${{ secrets.COZE_TOKEN }}
      run: |
        echo "ğŸ” æµ‹è¯•æœåŠ¡è®¿é—®ä»¤ç‰Œ (SAT)..."
        echo "ä»¤ç‰Œç±»å‹: æœåŠ¡è®¿é—®ä»¤ç‰Œ"
        echo "ä»¤ç‰Œå‰ç¼€: ${COZE_TOKEN:0:10}"
        echo "ä»¤ç‰Œé•¿åº¦: ${#COZE_TOKEN} å­—ç¬¦"
        
        echo "ğŸš€ å‘é€æµ‹è¯•è¯·æ±‚..."
        
        response=$(curl -s -w "HTTP_STATUS:%{http_code}" \
          -X POST "https://api.coze.cn/v1/workflow/stream_run" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $COZE_TOKEN" \
          -H "User-Agent: GitHub-Actions-SAT-Test" \
          -d '{
            "workflow_id": "7565827159563550756",
            "parameters": {}
          }')
        
        http_status=$(echo "$response" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d':' -f2)
        response_body=$(echo "$response" | sed 's/HTTP_STATUS:[0-9]*//')
        
        echo "ğŸ“Š HTTP çŠ¶æ€ç : $http_status"
        echo "ğŸ“„ å®Œæ•´å“åº”: $response_body"
        
        # è¯¦ç»†åˆ†æç»“æœ
        if [ "$http_status" -eq 200 ]; then
          echo "ğŸ‰ âœ… SAT ä»¤ç‰Œæµ‹è¯•æˆåŠŸï¼"
          echo "ğŸ’¡ ç°åœ¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªé•¿æœŸæœ‰æ•ˆçš„ä»¤ç‰Œäº†"
          echo "ğŸ“… å¯ä»¥è®¾ç½®å®šæ—¶ä»»åŠ¡äº†"
        elif [ "$http_status" -eq 401 ]; then
          echo "âŒ SAT ä»¤ç‰Œè®¤è¯å¤±è´¥"
          echo "å¯èƒ½åŸå› :"
          echo "  1. ä»¤ç‰Œæƒé™ä¸è¶³"
          echo "  2. å·¥ä½œæµIDé”™è¯¯" 
          echo "  3. æ‰£å­å¹³å°é™åˆ¶äº†GitHub IP"
          echo "  4. ä»¤ç‰Œæœªæ­£ç¡®æ¿€æ´»"
        else
          echo "âš ï¸ å…¶ä»–é”™è¯¯: $http_status"
          echo "å“åº”è¯¦æƒ…: $response_body"
        fi
